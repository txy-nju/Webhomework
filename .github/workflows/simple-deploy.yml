name: ç®€å•éƒ¨ç½²

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: "éƒ¨ç½²ç¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ä¸‹è½½ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      # æ„å»ºåç«¯
      - name: ğŸ—ï¸ æ„å»ºåç«¯
        run: |
          cd back
          npm ci
          npm run build
          echo "âœ… åç«¯æ„å»ºå®Œæˆ"

      # æ„å»ºå‰ç«¯
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: |
          cd frontier
          npm ci
          npm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

      # åˆ›å»ºéƒ¨ç½²åŒ…
      - name: ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          mkdir -p deployment
          cp -r back/dist deployment/backend-dist
          cp -r back/package*.json deployment/
          cp -r frontier/dist deployment/frontend-dist
          tar -czf deployment-${{ github.sha }}.tar.gz deployment/
          echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"

      # ä¸Šä¼ éƒ¨ç½²åŒ…
      - name: ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package
          path: deployment-${{ github.sha }}.tar.gz
          retention-days: 7

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: ğŸ‰ éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸš€ éƒ¨ç½²æµç¨‹å®Œæˆï¼"
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å·²åˆ›å»ºå¹¶ä¸Šä¼ "
          echo "ğŸ”— ä¸‹è½½é“¾æ¥å°†åœ¨Actionsé¡µé¢çš„Artifactsä¸­æ‰¾åˆ°"
          echo "â° æ—¶é—´: $(date)"
          echo "ğŸŒ ç¯å¢ƒ: ${{ github.event.inputs.environment }}"

          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œè¯·ç¡®ä¿ï¼š"
            echo "   - æ•°æ®åº“å·²å¤‡ä»½"
            echo "   - æœåŠ¡å™¨å‡†å¤‡å°±ç»ª" 
            echo "   - ç›‘æ§ç³»ç»Ÿæ­£å¸¸"
          fi

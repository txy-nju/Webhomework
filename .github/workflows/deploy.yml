name: Deploy to Production

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

  release:
    types: [published] # å‘å¸ƒreleaseæ—¶è‡ªåŠ¨è§¦å‘

env:
  NODE_VERSION: "20.x"
  BACKEND_PORT: 7001
  FRONTEND_PORT: 3000

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            back/package-lock.json
            frontier/package-lock.json

      # æ„å»ºåç«¯
      - name: Build backend
        run: |
          cd back
          npm ci
          npm run build
          echo "Backend build completed"

      # æ„å»ºå‰ç«¯
      - name: Build frontend
        run: |
          cd frontier
          npm ci
          npm run build
          echo "Frontend build completed"
        env:
          VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      # Dockeræ„å»ºï¼ˆå¦‚æœä½¿ç”¨Dockeréƒ¨ç½²ï¼‰
      - name: Build Docker images
        run: |
          # æ„å»ºåç«¯Dockeré•œåƒ
          docker build -t sports-app-backend:${{ github.sha }} ./back

          # æ„å»ºå‰ç«¯Dockeré•œåƒ
          docker build -t sports-app-frontend:${{ github.sha }} ./frontier

      # éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ï¼ˆç¤ºä¾‹ï¼šä½¿ç”¨SSHï¼‰
      - name: Deploy to server
        if: github.event.inputs.environment != 'staging'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # åœæ­¢ç°æœ‰æœåŠ¡
            sudo systemctl stop sports-app-backend || true
            sudo systemctl stop sports-app-frontend || true

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            sudo cp -r /opt/sports-app /opt/sports-app-backup-$(date +%Y%m%d_%H%M%S) || true

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p /opt/sports-app/{backend,frontend}

            # ä¸Šä¼ æ–°ç‰ˆæœ¬ï¼ˆè¿™é‡Œéœ€è¦å…ˆå°†æ„å»ºç»“æœä¼ è¾“åˆ°æœåŠ¡å™¨ï¼‰
            # å®é™…éƒ¨ç½²ä¸­ä½ å¯èƒ½éœ€è¦ä½¿ç”¨rsyncæˆ–scp

            # å®‰è£…åç«¯ä¾èµ–å¹¶å¯åŠ¨
            cd /opt/sports-app/backend
            sudo npm ci --only=production
            sudo systemctl start sports-app-backend
            sudo systemctl enable sports-app-backend

            # éƒ¨ç½²å‰ç«¯æ–‡ä»¶åˆ°nginx
            sudo cp -r /opt/sports-app/frontend/dist/* /var/www/sports-app/
            sudo systemctl reload nginx

            # å¥åº·æ£€æŸ¥
            sleep 10
            curl -f http://localhost:7001/api/health || exit 1

      # éƒ¨ç½²åˆ°Vercelï¼ˆå‰ç«¯ï¼‰
      - name: Deploy frontend to Vercel
        if: github.event.inputs.environment == 'production'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./frontier
          vercel-args: "--prod"

      # éƒ¨ç½²åˆ°Herokuï¼ˆåç«¯ï¼‰
      - name: Deploy backend to Heroku
        if: github.event.inputs.environment == 'production'
        uses: akhileshns/heroku-deploy@v3.12.14
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "your-sports-app-backend"
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "back"

      # éƒ¨ç½²åæµ‹è¯•
      - name: Post-deployment tests
        run: |
          echo "Running post-deployment tests..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ éƒ¨ç½²åçš„å¥åº·æ£€æŸ¥
          sleep 30
          # curl -f ${{ steps.deploy.outputs.page_url }}/api/health
          echo "Post-deployment tests completed"

      # éƒ¨ç½²å®Œæˆæç¤º
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ"
